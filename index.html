<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculator</title>
    <style>
        body { font-family: sans-serif; background: #000; color: #fff; margin: 0; padding: 10px; }
        .hidden { display: none !important; }

        /* GHOST MODE: Calculator */
        #calc { max-width: 300px; margin: 50px auto; background: #222; padding: 15px; border-radius: 10px; }
        #calc-display { width: 100%; height: 50px; background: #000; color: #0f0; text-align: right; padding: 10px; font-size: 24px; box-sizing: border-box; margin-bottom: 10px; }
        .btn-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; }
        .btn-grid button { padding: 15px; background: #333; color: #fff; border: none; font-size: 18px; cursor: pointer; }

        /* CHAT UI */
        #chat-container { max-width: 500px; margin: auto; }
        #msgs { height: 60vh; overflow-y: auto; border: 1px solid #333; padding: 10px; background: #111; margin-bottom: 10px; }
        .m { margin-bottom: 15px; border-bottom: 1px solid #222; padding-bottom: 5px; }
        .meta { font-size: 10px; color: #666; }
        .him { color: #4fc3f7; } .her { color: #f06292; }

        /* CONTROLS */
        .controls { display: grid; grid-template-columns: 1fr auto auto; gap: 5px; }
        input[type="text"] { background: #222; border: 1px solid #444; color: #fff; padding: 10px; }
        .tool-btn { background: #444; color: #fff; border: none; padding: 10px; cursor: pointer; }

        /* MEDIA */
        img.chat-img { max-width: 200px; border-radius: 8px; margin-top: 5px; cursor: pointer; }
        audio { height: 30px; margin-top: 5px; width: 100%; }

        /* NUKE */
        #nuke-btn { background: #900; width: 100%; height: 60px; font-weight: bold; margin-top: 20px; }
        #typing { font-size: 12px; color: #0f0; height: 15px; margin-bottom: 5px; }
    </style>
</head>
<body>

<!-- GHOST MODE: CALCULATOR -->
<div id="calc">
    <div id="calc-display">0</div>
    <div class="btn-grid">
        <button onclick="cNum(7)">7</button><button onclick="cNum(8)">8</button><button onclick="cNum(9)">9</button><button onclick="cNum('/')">/</button>
        <button onclick="cNum(4)">4</button><button onclick="cNum(5)">5</button><button onclick="cNum(6)">6</button><button onclick="cNum('*')">*</button>
        <button onclick="cNum(1)">1</button><button onclick="cNum(2)">2</button><button onclick="cNum(3)">3</button><button onclick="cNum('-')">-</button>
        <button onclick="cNum(0)">0</button><button onclick="cNum('.')">.</button><button onclick="cCheck()" style="background:#f90">=</button><button onclick="cNum('+')">+</button>
        <button onclick="cClear()" style="grid-column: span 4; background:#666">C</button>
    </div>
</div>

<!-- REAL CHAT -->
<div id="chat-container" class="hidden">
    <div id="last-seen" class="meta">Connecting...</div>
    <div id="typing"></div>
    <div id="msgs"></div>

    <div class="controls">
        <input type="text" id="ti" placeholder="Message..." oninput="handleTyping()">
        <button class="tool-btn" onclick="document.getElementById('fi').click()">üñºÔ∏è</button>
        <button class="tool-btn" id="rec-btn" onclick="toggleRecord()">üé§</button>
    </div>
    <button onclick="sendText()" style="width:100%; margin-top:5px; padding:10px; background:#007bff; border:none; color:#fff">SEND MESSAGE</button>

    <input type="file" id="fi" class="hidden" accept="image/*" onchange="sendImg(this)">
    <button id="nuke-btn" onclick="nuke()">‚ö†Ô∏è NUKE ALL MESSAGES</button>
    <button onclick="logout()" style="width:100%; background:#333; color:#888; border:none; margin-top:10px; padding:10px">EXIT</button>
</div>

<script>
    const API = "https://script.google.com/macros/s/AKfycbx2pw-gnFybs8jK1aT1DAbN5VYG1AncQRnYOBWhg4ht5SnIJgK_41ArAHwBeUy6qR4/exec";
    let token = localStorage.getItem('p_token');
    let typingTimer;
    let isRecording = false;
    let recorder;
    let audioChunks = [];

    if(token) unlock();

    // CALC LOGIC
    function cNum(n) { document.getElementById('calc-display').innerText += n; }
    function cClear() { document.getElementById('calc-display').innerText = ''; }
    function cCheck() {
        const d = document.getElementById('calc-display').innerText;
        if(d.includes('777')) { // SECRET CODE
            let p = prompt("Access Key?");
            if(p === 'iloverere' || p === 'Ilovebaby') {
                token = p;
                localStorage.setItem('p_token', p);
                unlock();
            }
        } else {
            try { document.getElementById('calc-display').innerText = eval(d); } catch(e) { cClear(); }
        }
    }

    function unlock() {
        document.getElementById('calc').classList.add('hidden');
        document.getElementById('chat-container').classList.remove('hidden');
        refresh();
        setInterval(refresh, 5000);
    }

    // TYPING SENSOR
    function handleTyping() {
        clearTimeout(typingTimer);
        setTyping(true);
        typingTimer = setTimeout(() => setTyping(false), 3000);
    }

    async function setTyping(status) {
        fetch(API, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'typing', token, status }) });
    }

    // SENDING LOGIC
    async function sendText() {
        const i = document.getElementById('ti');
        if(!i.value) return;
        const b64 = btoa(unescape(encodeURIComponent(i.value)));
        i.value = '';
        await post({ action: 'send', token, msg: b64, type: 'text' });
        refresh();
    }

    async function sendImg(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = async (e) => {
            const b64 = e.target.result.split(',')[1];
            await post({ action: 'send', token, msg: b64, type: 'img' });
            refresh();
        };
        reader.readAsDataURL(file);
    }

    async function toggleRecord() {
        const btn = document.getElementById('rec-btn');
        if(!isRecording) {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            recorder = new MediaRecorder(stream);
            recorder.ondataavailable = e => audioChunks.push(e.data);
            recorder.onstop = async () => {
                const blob = new Blob(audioChunks, { type: 'audio/webm' });
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const b64 = e.target.result.split(',')[1];
                    await post({ action: 'send', token, msg: b64, type: 'audio' });
                    refresh();
                };
                reader.readAsDataURL(blob);
                audioChunks = [];
            };
            recorder.start();
            btn.innerText = "üõë";
            btn.style.background = "#f00";
            isRecording = true;
        } else {
            recorder.stop();
            btn.innerText = "üé§";
            btn.style.background = "#444";
            isRecording = false;
        }
    }

    async function post(data) {
        return fetch(API, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) });
    }

    async function refresh() {
        try {
            const res = await fetch(`${API}?token=${token}`);
            const data = await res.json();
            const box = document.getElementById('msgs');

            document.getElementById('typing').innerText = data.typingStatus ? "The other is typing..." : "";
            document.getElementById('last-seen').innerText = "Last check: " + new Date(data.lastSeen).toLocaleTimeString();

            box.innerHTML = data.messages.map(m => {
                const isHim = m.t === 'iloverere';
                const cls = isHim ? 'him' : 'her';
                const name = isHim ? 'H' : 'S';
                let content = '';

                if(m.type === 'img') content = `<img src="data:image/jpeg;base64,${m.m}" class="chat-img" onclick="window.open(this.src)">`;
                else if(m.type === 'audio') content = `<audio controls src="data:audio/webm;base64,${m.m}"></audio>`;
                else content = decodeURIComponent(escape(atob(m.m)));

                return `<div class="m"><b class="${cls}">${name}:</b> ${content}</div>`;
            }).join('');
            box.scrollTop = box.scrollHeight;
        } catch(e) {}
    }

    async function nuke() {
        if(confirm("Erase all history permanently?")) {
            await post({ action: 'nuke', token });
            refresh();
        }
    }

    function logout() {
        localStorage.clear();
        window.location.replace("https://www.google.com");
    }
</script>
</body>
</html>